{% extends 'base.html' %}
{% load static %}

{% block title %}Ожидание игроков{% endblock %}

{% block content %}
    <div class="waiting-container">
        <div class="overlay"></div>

        <div class="content">
            <h1 class="title">OЖИДАНИЕ ИГРOКOВ</h1>
            <div id="timer" style="display: none;">Starting in <span id="countdown">10</span> seconds</div>
            <div id="players-list" class="players-list" style="border: none; background-color: transparent;"></div>

            <div class="qr-container">
                <img src="{% static 'images/qr.png' %}" alt="QR-код для подключения">
            </div>

            <div class="loading">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>

    <script>
        let playerCount = 0;
        let timerId = null;
        let countdownInterval = null;
        let countdown = 10;

        function startTimer() {
            countdown = 10;
            document.getElementById('timer').style.display = 'block';
            document.getElementById('countdown').textContent = countdown;
            countdownInterval = setInterval(function() {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            }, 1000);
            timerId = setTimeout(function() {
                if (playerCount % 2 === 0) {
                    window.location.href = '/wait/';
                } else {
                    startTimer();
                }
            }, 10000);
        }

        function updateTimer() {
            if (playerCount >= 4) {
                if (timerId === null) {
                    startTimer();
                }
            } else {
                if (timerId !== null) {
                    clearTimeout(timerId);
                    timerId = null;
                }
                if (countdownInterval !== null) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                document.getElementById('timer').style.display = 'none';
            }
        }

        const list = document.getElementById('players-list');
        const socket = new WebSocket(
            (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
            + window.location.host
            + '/ws/players/'
        );

        socket.onopen = function () {
            console.log('WebSocket соединение открыто');
        };

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.type === 'init') {
                list.innerHTML = '';
                data.players.forEach(function(player) {
                    const div = document.createElement('div');
                    div.textContent = player.username;
                    div.dataset.id = player.id;
                    div.classList.add('player-card');
                    list.append(div);
                });
                playerCount = data.players.length;
                updateTimer();
            }

            if (data.type === 'new_player') {
                const exists = list.querySelector(`.player-card[data-id="${data.player.id}"]`);
                if (!exists) {
                    const div = document.createElement('div');
                    div.textContent = data.player.username;
                    div.dataset.id = data.player.id;
                    div.classList.add('player-card');
                    list.append(div);
                    playerCount++;
                    updateTimer();
                }
            }

            if (data.type === 'player_left') {
                const toRemove = list.querySelector(`.player-card[data-id="${data.player.id}"]`);
                if (toRemove) {
                    toRemove.remove();
                    playerCount--;
                    updateTimer();
                }
            }
        };

        socket.onerror = function (error) {
            console.error('WebSocket ошибка:', error);
        };

        socket.onclose = function (e) {
            console.log('WebSocket закрыт, код:', e.code);
        };
    </script>
{% endblock %}