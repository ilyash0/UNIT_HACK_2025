{% extends 'base.html' %}
{% load static %}

{% block title %}Ожидание игроков{% endblock %}

{% block content %}
    <div class="waiting-container">
        <div class="overlay"></div>

        <div class="content">
            <h1 class="title">OЖИДАНИЕ ИГРOКOВ</h1>

            <div id="players-list" class="players-list" style="border: none; background-color: transparent;">
            </div>

            <div class="qr-container">
                <img src="{% static 'images/qr.png' %}" alt="QR-код для подключения">
            </div>

            <div class="loading">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>

    <script>
        const list = document.getElementById('players-list');
        const socket = new WebSocket(
            (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
            + window.location.host
            + '/ws/players/'
        );

        socket.onopen = function () {
            console.log('WebSocket соединение открыто');
        };

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.type === 'init') {
                list.innerHTML = '';
                data.players.forEach(function(player) {
                    const div = document.createElement('div');
                    div.textContent = player.username;
                    div.dataset.id = player.id;
                    div.classList.add('player-card');
                    list.append(div);
                });
            }

            if (data.type === 'new_player') {
                const exists = list.querySelector(`.player-card[data-id="${data.player.id}"]`);
                if (!exists) {
                    const div = document.createElement('div');
                    div.textContent = data.player.username;
                    div.dataset.id = data.player.id;
                    div.classList.add('player-card');
                    list.append(div);
                }
            }

            if (data.type === 'player_left') {
                const toRemove = list.querySelector(`.player-card[data-id="${data.player.id}"]`);
                if (toRemove) {
                    toRemove.remove();
                }
            }
        };

        socket.onerror = function (error) {
            console.error('WebSocket ошибка:', error);
        };

        socket.onclose = function (e) {
            console.log('WebSocket закрыт, код:', e.code);
        };
    </script>
{% endblock %}